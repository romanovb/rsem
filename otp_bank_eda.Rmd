---
title: "Анализ клиентской базы ОТП-банка"
author: "Б. Романов, М. Вотякова, Д. Пак"
output: 
  html_document: 
    toc: yes
---

# Введение

Этот набор был подготовлен для конкурса по решению прикладной задачи предсказания отклика клиентов на маркетинговую кампанию в рамках всероссийской конференции «Математические методы распознавания образов» ММРО-15 (2011). Описание и результаты конкурса  размещены на ресурсе www.machinelearning.ru в разделе "Конкурсы".

Данные предоставлены ОТП Банком (www.otpbank.ru), который входит в число 50 крупнейших банков России, занимает 2-е место на рынке потребительского кредитования, 3-е место на рынке беззалогового кредитования, и 4-е место на рынке кредитных карт.

# Постановка задачи
Один из способов повышения эффективности взаимодействия банка с клиентами заключается в том, чтобы отправлять предложение о новой услуге не всем клиентам банка, а только некоторой части, выбираемой по принципу наибольшей склонности к отклику на данное предложение.

В этом задании вам предстоит выполнить разведочный анализ данных о клиентах банка с целью выявления факторов, влияющих на отклик.

# Описание данных

Исходная выборка («выборка А») содержит записи о 15 223 клиентов, классифицированных на два класса:
1 — отклик был (1812 клиентов),
0 — отклика не было (13411 клиентов).

Данные находятся в файле: `otp_bank.xlsx`, описание переменных доступно на листе `fields`.


# Подготовка данных к анализу
## Загрузка и изучение структуры данных

```{r Загрузка пакетов, message=FALSE, warning=FALSE}
library(tidyverse)
library(forcats) # удобная работа с факторами
library(readxl) # считывание данных из Excel
library(scales) # Форматирование осей на графиках ggplot
```

Загрузим данные и описание переменных.

```{r Загрузка данных}
otp <- read_excel('otp_bank.xlsx')
fields <- read_excel('otp_bank.xlsx', 2)
```

После загрузки необходимо изучить структуру данных, диапазоны изменения всех величин, наличие пропусков, аномальных значений.

```{r Знакомство с данными}
glimpse(otp) # Тип данных столбцов (можно использовать вместо str())
filter(fields, name == 'dependants') # Как посмотреть назначение переменной

summary(otp) # Описательная статистика по каждой переменной

unique(otp$education) # Какие значения встречаются в столбце
table(otp$education) # Таблица частот

NAs <- colSums(is.na(otp)) # Количество пропущенных значений
NAs[NAs > 0] # В каких переменных есть пропуски?

```

## Удаление аномальных значений

Для замены аномальных значений на пропуски (NA) удобно использовать функцию `ifelse()`  (замена по условию) или `na_if()` (замена конкретного значения).

```{r Удаление аномальных значений из поля Срок проживания}
otp <- otp %>%
  mutate(fact_living_term = 
           ifelse(fact_living_term > 1000 | fact_living_term < 0, 
                  NA, fact_living_term))

ggplot(otp, aes(x = "", y = fact_living_term)) + 
  geom_boxplot()

```

Аналогичным образом удалите аномальные значения из поля `work_time`.

```{r Удаление аномальных значений стажа работы}
# Напишите свой код в этом блоке

```


## Работа с пропущенными значениями

В поле с количеством предыдущих кредитных карт - `previous_card_num_utilized` много пропусков, которые обозначают, что у клиента до этого не было кредитных карт, выданных банком. Такие пропущенные значения можно заменить на нули. Для этого можно использовать функцию `if_else()` в сочетании с `is.na()`, но удобнее применить специальную функцию пакета `dplyr` - `coalesce()`.

```{r Замена пропусков в поле с количеством использованных ранее карт}
otp <- otp %>%
  mutate(previous_card_num_utilized = 
           coalesce(previous_card_num_utilized, 0))
```

# Портрет клиента

## Возраст

Возраст - это непрерывная (количественная) величина. Для исследования распределения необходимо использовать гистограмму.

```{r Распределение возраста}
ggplot(otp, aes(x = age)) + 
  geom_histogram(binwidth = 2) # Гистограмма

# Альтернативы, удобные для сравнения по подгруппам:
ggplot(otp, aes(x = age)) + 
  # Полигон частот
  geom_freqpoly(aes(y = ..density.., 
                    color='Полигон частот'), 
                binwidth = 2) + 
  # Плотность
  geom_density(aes(color='Плотность'), adjust = 1.5)  +
  
  labs(color = 'Способ визуализации')

```

## Пол

Пол кодируется в данных двумя значениями - 0 и 1.

```{r Исходные данные о поле клиентов}
ggplot(otp, aes(x = gender)) + 
  geom_bar(aes(y = ..prop.. )) + 
  coord_flip()

```


Преобразуем пол в факторную переменную с помощью функции `factor()`. Для факторной переменной можно указать определенный порядок следования уровней и метки для уровней.

```{r Создание факторной переменной для пола}
otp <- otp %>%
  mutate(genderf = factor(gender, 
                          levels = c(0, 1), 
                          labels = c('ж','м')))

glimpse(otp$genderf)
summary(otp$genderf)


ggplot(otp, aes(x = "")) + 
  geom_bar(aes(fill = genderf), position = 'fill')  +
  labs(x = NULL, y = 'Доля', 
       title = 'Доли клиентов по полу') +
  labs(fill = 'Пол') +
  scale_y_continuous(labels = percent)

```

Аналогичным образом, создайте факторную переменную `targetf`, которая должна принимать значение `Отклик` (1), если клиент откликнулся на предложение и `Нет отклика` (0), если не откликнулся на предложение.

```{r Создание факторной переменной для отклика}

# Напишите здесь код для добавления переменной targetf в набор otp


# Проверьте, сколько значений получилось в каждой категории по отклику и сравните со значениями, указанными во введении

```


## Образование

Уровень образования - дискретная (качественная, или категориальная) переменная. Для анализа ее распределения необходимо использовать столбиковую диаграмму с частотами или относительными частотами.

```{r Уровни образования}
ggplot(otp) + 
  geom_bar(aes(x = education, y = ..prop.., group = 1)) +
  scale_y_continuous(labels = percent) + 
  labs(x = NULL) + 
  coord_flip()

```

Сейчас уровни образования идут в алфавитном порядке. Для облегчения интерпретации результатов необходимо придать категориям какой-либо логический порядок. Уровни этой переменной можно рассматривать как упорядоченные (от самого низкого, до самого высокого уровня). Также можно упорядочить категории по убыванию некоторой их характеристики - например, частоты.



```{r Определение порядка уровней фактора вручную}
unique(otp$education) # Какие значения есть в данных?

education_levels <-
  c("Неполное среднее", 
    "Среднее специальное",
    "Среднее",
    "Неоконченное высшее",
    "Высшее",
    "Два и более высших образования",
    "Ученая степень")
                                 


otp <- otp %>%
  mutate(educationf = factor(education, levels = education_levels))

ggplot(otp) + 
  geom_bar(aes(x = educationf, y = ..prop.., group = 1)) +
  scale_y_continuous(labels = percent) + 
  coord_flip()
```

Теперь категории идут в соответствии с уровнем образования клиента.

Для удобной работы с уровнями факторов был разработан пакет `forcats`. Несколько полезных примеров его использования описаны в [15 главе книги R for Data Science](http://r4ds.had.co.nz/factors.html). 

Для переупорядочения уровней фактора по частоте можно использовать функцию `fct_infreq()`  Чтобы изменить порядок уровней фактора на обратный, можно использовать функцию `fct_rev()`.

Обе функции можно применять в сочетании с `desc()` для сортировки по убыванию.


```{r Упорядочение категорий по частоте}
ggplot(otp) + geom_bar(aes(x = fct_infreq(education), y = ..prop.., group = 1)) +
  scale_y_continuous(labels = percent) + 
  labs(x = NULL, title = 'Уровень образования') + 
  coord_flip()

```


## Профессия

В каких отраслях промышленности работают клиенты банка?

** Совет: ** для упорядочения категорий используйте функцию `fct_infreq()`, фактор заранее создавать не обязательно.


```{r Частота профессий}
# Напишите здесь свой код

```


## Сочетание двух факторов

При разведочном анализе интересны сочетания различных переменных, т.к. подобные визуализации могут раскрывать интересные зависимости, которые затем можно использовать при моделировании.

Изучим, как связаны уровень образования и пол. Обе переменные - дискретные, необходимо применить столбиковую диаграмму.

```{r Связь пола и уровня образования}

ggplot(otp, aes(x = genderf, fill = educationf)) +
  geom_bar(position = 'fill') +
  #scale_fill_brewer(palette = 'Blues') +
  scale_y_continuous(labels = percent) +
  labs(fill = 'Уровень образования')

```


Сравните распределения возраста клиентов в зависимости от пола. Учтите, что возраст - это непрерывная переменная, поэтому для сравнения необходимо использовать гистограмму. А лучше - полигон частот или плотность.

```{r Связь пола и возраста}


```

## Связь дискретной и непрерывной переменной

Если наблюдений мало, то сравнение распределений непрерывной переменной с помощью гистограмм и даже ящичных диаграмм может быть затруднено. В этой ситуации можно сравнивать числовые характеристики распределений для групп.

```{r Сравнение средних доходов по уровням образования}

ggplot(otp, aes(x = educationf, y = personal_income)) + 
  stat_summary(fun.y = mean, na.rm = T,
               geom = 'bar') +
  labs(x = NULL, title = 'Уровень образования и персональный доход') +
  coord_flip()

```


Упорядочение категорий фактора по среднему личному доходу клиента можно выполнить с помощью функции `fct_reorder(f, x, fun)` (упорядочивает фактор `f` по значению произвольной переменной `x`, к которой применяется агрегирующая функция `fun`). 

```{r Упорядочение уровней образования по среднему доходу}

ggplot(otp) + 
  stat_summary(aes(x = fct_reorder(education, 
                                   personal_income, 
                                   fun = mean, na.rm = T),
                   y = personal_income),
               fun.y = mean, na.rm = T,
               geom = 'bar') +
  labs(x = NULL, 
       title = 'Уровень образования и персональный доход') +
  coord_flip()


```

Аналогичного результата можно было добиться и рассчитав отдельный набор данных со средними значениями дохода при помощи функций для трансформации данных из пакета `dplyr`.

```{r Упорядочение данных через специально подготовленный набор}

edu_income <- 
  otp %>% 
  group_by(educationf) %>% 
  summarize(avg_income = mean(personal_income, na.rm = T)) %>%
  arrange(avg_income)

edu_income

# В порядке увеличения уровня образования
ggplot(edu_income, aes(x = educationf, y = avg_income)) +
  geom_bar(stat = 'identity') + coord_flip()

# В порядке увеличения зарплаты
ggplot(edu_income, aes(x = fct_inorder(educationf), y = avg_income)) +
  geom_bar(stat = 'identity') + coord_flip()

```


Изучите, как изменяется доход клиентов в зависимости от профессии

```{r Доход и профессия}

```


# Исследование влияние различных факторов на целевую переменную

Используя визуализацию, изучите влияние следующих факторов на целевую переменную:

- возраст  
- социальный статус (работа, пенсия)  
- пол  
- количество детей (нет, 1 ребенок, более одного ребенка)  
- уровень образования  
- семейный статус  
- персональный доход  
- регион  
- наличие автомобиля  
- наличие кредита  
- наличие просроченных платежей по кредитам  
- стаж работы

Рассмотрите как минимум по одному примеру связи между тремя переменными, одна из которых - целевая, а другие:

- обе - количественные,  
- обе - категориальные,
- одна - количественная, а другая - категориальная.

Попробуйте несколько способов визуализации таких зависимостей и выберите из них наиболее наглядный.

На основе результатов вашего анализа напишите вывод о том, среди каких клиентов банку следует искать потенциальных покупателей новой услуги.