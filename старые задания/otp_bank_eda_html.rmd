---
title: "Анализ клиентской базы ОТП-банка"
author: "Пак Дарья, Романов Борис, Вотякова Мария БЛГ153"
output: 
  html_document: 
    toc: yes
---

# Введение

Этот набор был подготовлен для конкурса по решению прикладной задачи предсказания отклика клиентов на маркетинговую кампанию в рамках всероссийской конференции «Математические методы распознавания образов» ММРО-15 (2011). Описание и результаты конкурса  размещены на ресурсе www.machinelearning.ru в разделе "Конкурсы".

Данные предоставлены ОТП Банком (www.otpbank.ru), который входит в число 50 крупнейших банков России, занимает 2-е место на рынке потребительского кредитования, 3-е место на рынке беззалогового кредитования, и 4-е место на рынке кредитных карт.

# Постановка задачи
Один из способов повышения эффективности взаимодействия банка с клиентами заключается в том, чтобы отправлять предложение о новой услуге не всем клиентам банка, а только некоторой части, выбираемой по принципу наибольшей склонности к отклику на данное предложение.

В этом задании вам предстоит выполнить разведочный анализ данных о клиентах банка с целью выявления факторов, влияющих на отклик.

# Описание данных

Исходная выборка («выборка А») содержит записи о 15 223 клиентов, классифицированных на два класса:
1 — отклик был (1812 клиентов),
0 — отклика не было (13411 клиентов).

Данные находятся в файле: `otp_bank.xlsx`, описание переменных доступно на листе `fields`.


# Подготовка данных к анализу
## Загрузка и изучение структуры данных

```{r Загрузка пакетов, message=FALSE, warning=FALSE}
library(tidyverse)
library(forcats) # удобная работа с факторами
library(readxl) # считывание данных из Excel
library(scales) # Форматирование осей на графиках ggplot
library(mapproj)
library(dplyr)
library(gridExtra)
library(grid)
library(ggthemes)
library(RColorBrewer)
library(ggfortify)
library(rworldmap)

```

Загрузим данные и описание переменных.

```{r Загрузка данных}
otp <- read_excel('otp_bank.xlsx')
fields <- read_excel('otp_bank.xlsx', 2)
```

После загрузки необходимо изучить структуру данных, диапазоны изменения всех величин, наличие пропусков, аномальных значений.

```{r Знакомство с данными}
glimpse(otp) # Тип данных столбцов (можно использовать вместо str())
filter(fields, name == 'dependants') # Как посмотреть назначение переменной

summary(otp) # Описательная статистика по каждой переменной

unique(otp$education) # Какие значения встречаются в столбце
table(otp$education) # Таблица частот

NAs <- colSums(is.na(otp)) # Количество пропущенных значений
NAs[NAs > 0] # В каких переменных есть пропуски?

```

## Удаление аномальных значений

Для замены аномальных значений на пропуски (NA) удобно использовать функцию `ifelse()`  (замена по условию) или `na_if()` (замена конкретного значения).

```{r Удаление аномальных значений из поля Срок проживания}
otp <- otp %>%
  mutate(fact_living_term = 
           ifelse(fact_living_term > 1000 | fact_living_term < 0, 
                  NA, fact_living_term))

ggplot(otp, aes(x = "", y = fact_living_term)) + 
  geom_boxplot()

```

Аналогичным образом удалите аномальные значения из поля `work_time`.

```{r Ящичная диаграмма до удаления аномальных значений поля `work_time`}
ggplot(otp, aes(x = "", y = work_time)) + 
  geom_boxplot()
```


```{r Удаление аномальных значений стажа работы}
# Напишите свой код в этом блоке
otp <- otp %>%
  mutate(work_time = 
           ifelse(work_time > 720 | work_time < 0, 
                  NA, work_time))
# Поскольку поле 'work_time' - это время работы на текущем месте в месяцах, то 720 месяцев или 60 лет - это, по нашему мнению, максимальный допустимый стаж работы.  
ggplot(otp, aes(x = "", y = work_time)) + 
  geom_boxplot()
```


## Работа с пропущенными значениями

В поле с количеством предыдущих кредитных карт - `previous_card_num_utilized` много пропусков, которые обозначают, что у клиента до этого не было кредитных карт, выданных банком. Такие пропущенные значения можно заменить на нули. Для этого можно использовать функцию `if_else()` в сочетании с `is.na()`, но удобнее применить специальную функцию пакета `dplyr` - `coalesce()`.

```{r Замена пропусков в поле с количеством использованных ранее карт}
otp <- otp %>%
  mutate(previous_card_num_utilized = 
           coalesce(previous_card_num_utilized, 0))
```

# Портрет клиента

## Возраст

Возраст - это непрерывная (количественная) величина. Для исследования распределения необходимо использовать гистограмму.

```{r Распределение возраста}
ggplot(otp, aes(x = age)) + 
  geom_histogram(binwidth = 2) # Гистограмма

# Альтернативы, удобные для сравнения по подгруппам:
ggplot(otp, aes(x = age)) + 
  # Полигон частот
  geom_freqpoly(aes(y = ..density.., 
                    color='Полигон частот'), 
                binwidth = 2) + 
  # Плотность
  geom_density(aes(color='Плотность'), adjust = 1.5)  +
  
  labs(color = 'Способ визуализации')

```

## Пол

Пол кодируется в данных двумя значениями - 0 и 1.

```{r Исходные данные о поле клиентов}
ggplot(otp, aes(x = gender)) + 
  geom_bar(aes(y = ..prop.. )) + 
  coord_flip()

```


Преобразуем пол в факторную переменную с помощью функции `factor()`. Для факторной переменной можно указать определенный порядок следования уровней и метки для уровней.

```{r Создание факторной переменной для пола}
otp <- otp %>%
  mutate(genderf = factor(gender, 
                          levels = c(0, 1), 
                          labels = c('ж','м')))

glimpse(otp$genderf)
summary(otp$genderf)


ggplot(otp, aes(x = "")) + 
  geom_bar(aes(fill = genderf), position = 'fill')  +
  labs(x = NULL, y = 'Доля', 
       title = 'Доли клиентов по полу') +
  labs(fill = 'Пол') +
  scale_y_continuous(labels = percent)

```

Аналогичным образом, создайте факторную переменную `targetf`, которая должна принимать значение `Отклик` (1), если клиент откликнулся на предложение и `Нет отклика` (0), если не откликнулся на предложение.

```{r Создание факторной переменной для отклика}

# Напишите здесь код для добавления переменной targetf в набор otp
otp <- otp %>%
  mutate(targetf = factor(target, 
                          levels = c(0, 1), 
                          labels = c('нет','да')))

glimpse(otp$targetf)
summary(otp$targetf)


ggplot(otp, aes(x = "")) + 
  geom_bar(aes(fill = targetf), position = 'fill')  +
  labs(x = NULL, y = 'Доля', 
       title = 'Доли клиентов по отклику') +
  labs(fill = 'Отклик') +
  scale_y_continuous(labels = percent)

# Проверьте, сколько значений получилось в каждой категории по отклику и сравните со значениями, указанными во введении

# Переменная targetf включает в себя два значения: "нет" и "да". Значений "нет" - 13411, значений "да" - 1812. 
# Значения переменной target из введения:
# 1 — отклик был (1812 клиентов),
# 0 — отклика не было (13411 клиентов).
# Как мы видим, исходные и полученные значения совпадают, то есть замена была проведена верно.
```


## Образование

Уровень образования - дискретная (качественная, или категориальная) переменная. Для анализа ее распределения необходимо использовать столбиковую диаграмму с частотами или относительными частотами.

```{r Уровни образования}
ggplot(otp) + 
  geom_bar(aes(x = education, y = ..prop.., group = 1)) +
  scale_y_continuous(labels = percent) + 
  labs(x = NULL) + 
  coord_flip()

```

Сейчас уровни образования идут в алфавитном порядке. Для облегчения интерпретации результатов необходимо придать категориям какой-либо логический порядок. Уровни этой переменной можно рассматривать как упорядоченные (от самого низкого, до самого высокого уровня). Также можно упорядочить категории по убыванию некоторой их характеристики - например, частоты.



```{r Определение порядка уровней фактора вручную}
unique(otp$education) # Какие значения есть в данных?

education_levels <-
  c("Неполное среднее", 
    "Среднее специальное",
    "Среднее",
    "Неоконченное высшее",
    "Высшее",
    "Два и более высших образования",
    "Ученая степень")
                                 


otp <- otp %>%
  mutate(educationf = factor(education, levels = education_levels))

ggplot(otp) + 
  geom_bar(aes(x = educationf, y = ..prop.., group = 1)) +
  scale_y_continuous(labels = percent) + 
  coord_flip()
```

Теперь категории идут в соответствии с уровнем образования клиента.

Для удобной работы с уровнями факторов был разработан пакет `forcats`. Несколько полезных примеров его использования описаны в [15 главе книги R for Data Science](http://r4ds.had.co.nz/factors.html). 

Для переупорядочения уровней фактора по частоте можно использовать функцию `fct_infreq()`  Чтобы изменить порядок уровней фактора на обратный, можно использовать функцию `fct_rev()`.

Обе функции можно применять в сочетании с `desc()` для сортировки по убыванию.


```{r Упорядочение категорий по частоте}
ggplot(otp) + geom_bar(aes(x = fct_infreq(education), y = ..prop.., group = 1)) +
  scale_y_continuous(labels = percent) + 
  labs(x = NULL, title = 'Уровень образования') + 
  coord_flip()

```


## Профессия

В каких отраслях промышленности работают клиенты банка?

** Совет: ** для упорядочения категорий используйте функцию `fct_infreq()`, фактор заранее создавать не обязательно.


```{r Частота профессий}
# Напишите здесь свой код
ggplot(otp) + 
  geom_bar(aes(x = fct_infreq(gen_industry), y = ..prop.., group = 1)) +
  scale_y_continuous(labels = percent) + 
  labs(x = NULL, title = 'Отрасли работы') + 
  coord_flip()

```
Как видно из диаграммы, клиенты банка работают в следующих отраслях промышленности: 
Металлургия/Промышленность/Машиностроение, Нефтегазовая промышленность, Энергетика. 
Из данных видов промышленности наибольшее число клиентов банка работают в Металлургии/Промышленности/Машиностроении, а наименьшее число работают в Энергетике.

## Сочетание двух факторов

При разведочном анализе интересны сочетания различных переменных, т.к. подобные визуализации могут раскрывать интересные зависимости, которые затем можно использовать при моделировании.

Изучим, как связаны уровень образования и пол. Обе переменные - дискретные, необходимо применить столбиковую диаграмму.

```{r Связь пола и уровня образования}

ggplot(otp, aes(x = genderf, fill = educationf)) +
  geom_bar(position = 'fill') +
  scale_fill_brewer(palette = 'Blues') +
  scale_y_continuous(labels = percent) +
  labs(fill = 'Уровень образования')

```


Сравните распределения возраста клиентов в зависимости от пола. Учтите, что возраст - это непрерывная переменная, поэтому для сравнения необходимо использовать гистограмму. А лучше - полигон частот или плотность.

```{r Связь пола и возраста}

# Гистограмма
ggplot(otp, aes(x = age, fill = genderf)) +
  geom_histogram(binwidth = 2) +
  scale_y_continuous(labels = percent) +
  labs(fill = 'Пол клиента')

# Плотность
ggplot(otp, aes(x = age, fill = genderf)) +
  geom_density(aes(color='Плотность'), adjust = 1.5)  +
  scale_y_continuous(labels = percent) +
  labs(fill = 'Пол клиента')

```
По гистограмме мы видим, что среди клиентов банка в каждой возрастной категории больше женщин, чем мужчин.

## Связь дискретной и непрерывной переменной

Если наблюдений мало, то сравнение распределений непрерывной переменной с помощью гистограмм и даже ящичных диаграмм может быть затруднено. В этой ситуации можно сравнивать числовые характеристики распределений для групп.

```{r Сравнение средних доходов по уровням образования}

ggplot(otp, aes(x = educationf, y = personal_income)) + 
  stat_summary(fun.y = mean, na.rm = T,
               geom = 'bar') +
  labs(x = NULL, title = 'Уровень образования и персональный доход') +
  coord_flip()

```


Упорядочение категорий фактора по среднему личному доходу клиента можно выполнить с помощью функции `fct_reorder(f, x, fun)` (упорядочивает фактор `f` по значению произвольной переменной `x`, к которой применяется агрегирующая функция `fun`). 

```{r Упорядочение уровней образования по среднему доходу}

ggplot(otp) + 
  stat_summary(aes(x = fct_reorder(education, 
                                   personal_income, 
                                   fun = mean, na.rm = T),
                   y = personal_income),
               fun.y = mean, na.rm = T,
               geom = 'bar') +
  labs(x = NULL, 
       title = 'Уровень образования и персональный доход') +
  coord_flip()


```

Аналогичного результата можно было добиться и рассчитав отдельный набор данных со средними значениями дохода при помощи функций для трансформации данных из пакета `dplyr`.

```{r Упорядочение данных через специально подготовленный набор}

edu_income <- 
  otp %>% 
  group_by(educationf) %>% 
  summarize(avg_income = mean(personal_income, na.rm = T)) %>%
  arrange(avg_income)

edu_income

# В порядке увеличения уровня образования
ggplot(edu_income, aes(x = educationf, y = avg_income)) +
  geom_bar(stat = 'identity') + coord_flip()

# В порядке увеличения зарплаты
ggplot(edu_income, aes(x = fct_inorder(educationf), y = avg_income)) +
  geom_bar(stat = 'identity') + coord_flip()

```


Изучите, как изменяется доход клиентов в зависимости от профессии

```{r Доход и профессия}
ggplot(otp) + 
  stat_summary(aes(x = fct_reorder(gen_title, 
                                   personal_income, 
                                   fun = mean, na.rm = T),
                   y = personal_income),
               fun.y = mean, na.rm = T,
               geom = 'bar') +
  labs(x = NULL, 
       title = 'Должность и персональный доход') +
  coord_flip()

```
Как мы видим, наибольший персональный доход среди клиентов банка у Руководителей высшего звена и Военнослужащих по контракту, а наименьший персональный доход у Рабочих и Работников сферы услуг.

# Исследование влияние различных факторов на целевую переменную

Используя визуализацию, изучите влияние следующих факторов на целевую переменную:

- возраст  кол +
- социальный статус (работа, пенсия)  кат +
- пол  кат +
- количество детей (нет, 1 ребенок, более одного ребенка)  кат +
- уровень образования  + кат
- семейный статус  кат +
- персональный доход  + кол
- регион  кат +
- наличие автомобиля  кат +
- наличие кредита  кат +
- наличие просроченных платежей по кредитам  кат +
- стаж работы кол 

```{r}
ggplot(otp, aes(x = educationf, fill =  targetf)) +
  geom_bar(position = 'fill') +
  scale_fill_brewer(palette = 'Oranges') +
  scale_y_continuous(labels = percent) +
  labs(fill = 'Отклик') + coord_flip()

```

*** Вывод***: В разрезе процентного соотношения в большей степени в кредите нуждаются люди со Двумя высшими и Неоконченным высшим образованием.

```{r Отклик в зависимости от уровеня образования и персонального дохода}
# Уровень образования - дискретная (качественная, или категориальная) переменная, Персональный доход - количественная переменная.
edu_income <- 
  otp %>% 
  group_by(educationf, targetf) %>% 
  summarize(avg_income = mean(personal_income, na.rm = T)) %>%
  arrange(avg_income)

edu_income

# В порядке увеличения уровня образования
ggplot(edu_income, aes(x = educationf, y = avg_income)) +
  facet_wrap(~targetf, ncol = 2) +
  geom_bar(stat = 'identity') +
labs(x = 'Уровень образования', y = 'Средний доход',
       title = 'Уровень образования и персональный доход', fill="Отклик")  +
coord_flip()

```

*** Вывод*** : Наиболее заинтересованы в предложении банка те, кто имеет два и более высших образования и чей средний персональный доход около 30 тысяч. А также люди с высшим, неоконченным высшим, средним, средним специальным образованием со средним доходом примерно 15 тысяч. Наименее заинтересованы люди с ученой степенью и неполным средним образованием.

```{r Отклик в зависимости от возраста и среднего персонального дохода}
# Возраст - количественная переменная, Персональный доход - количественная переменная.
edu_income <- 
  otp %>% 
  group_by(educationf, targetf, age) %>% 
  summarize(avg_income = mean(personal_income, na.rm = T)) %>%
  arrange(avg_income) 


ggplot(edu_income, aes(x=age, y= avg_income)) + 
    geom_point(aes (color = targetf), alpha=0.5) +
    ggtitle('Возраст и Средний персональный доход') +
  labs(x = 'Возраст', y = 'Средний персональный доход',
       color ="Отклик") 
```

*** Вывод***: Интерес к банку проявили в наибольшей степени люди от 21-22 до 45 лет со средним доходом от 10 до 20 тысяч. Чем старше люди заинтересованные в услугах банка (после 45 лет), тем меньше их доход. Но есть и те категории, у которых доход значительно превышает доход наиболее заинтересованной группы. Для них возможно предложение особых услуг.

```{r Отклик, пол и семейное положение}
# Пол - категориальная переменная, Семейное положение - категориальная переменная.
ggplot(otp,
  mapping = aes (x = marital_status, fill = targetf , y = ..count..)) +
  geom_bar(position = "fill") +
  facet_wrap(~genderf, ncol = 2) +
  labs(
    title = "Отклик, пол и семейное положение",
    x = "Семейное положение",
    y = "",
    fill ="Отклик") + 
  scale_y_continuous(labels = percent) + coord_flip()
```

***Вывод***: Наиболее заинтересованы в предложении банка мужчины и женщины, состоящие в браке, либо те, кто не состоял в браке совсем.

```{r Отклик, социальное положение и количество детей}

# Количество детей у клиента
otp <- otp %>%
  mutate(child_total_f = 
           ifelse(child_total > 1,  
                  'Более одного ребенка', ifelse (child_total < 1,  
                  'Нет детей', 'Один ребенок')))

ggplot(otp,
  mapping = aes (x = child_total_f, fill = targetf, y = ..count..)) +
  geom_bar(position = "fill") +
  facet_wrap(~socstatus_work_fl, ncol = 2) +
  labs(
    title = "Отклик, социальное положение и количество детей",
    x = "Количество детей",
    y = "",
    fill ="Отклик") + 
  scale_y_continuous(labels = percent)  + coord_flip()

ggplot(otp,
  mapping = aes (x = child_total_f, fill = targetf , y = ..count..)) +
  geom_bar(position = "fill") +
  facet_wrap(~socstatus_pens_fl, ncol = 2) +
  labs(
    title = "Отклик, социальное положение и количество детей",
    x = "Количество детей",
    y = "",
    fill ="Отклик") + 
  scale_y_continuous(labels = percent)  + coord_flip()
```

*** Вывод***: В услугах банка руждаются работающие люди (+ не пенсионеры) вне зависимости от наличия детей. Ничтожно малый процент не работающих людей, которые откликнулись на предложение, поэтому фокусироваться на них банку не стоит. Аналогичная ситуация с пенсионерами.

```{r Возрастные распределения}

ggplot(data = otp) +
  geom_histogram(mapping = aes(x= age, y = ..ncount..), binwidth =  1) +
  facet_wrap(~targetf) +
  labs(
    title = "Возрастные распределения",
    x = "Возраст",
    y = "Частота"
  )
```
***Вывод***: Откликаются на предложение банка люди в основном люди в возрасте 22-43 года. Именно на них стоит направить основное воздействие. Люди в возрасте 44-55 лет откликаются на подобные предложения гораздо реже.

```{r Отклик, образование и наличие автомобиля}
# Наличие автомобиля у клиента
otp <- otp %>%
  mutate(own_auto_f = 
           ifelse(own_auto > 0,  
                  'Есть авто', 'Нет авто'))
edu_income <- 
  otp %>% 
  group_by (educationf, targetf, age, own_auto_f ) %>% 
  summarize(avg_income = mean(personal_income, na.rm = T)) %>%
  arrange(avg_income) 



ggplot(edu_income, aes(x = own_auto_f, y = ..count.., fill = targetf)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = percent) +
labs(x = 'Наличие автомобиля', 
       title = 'Наличие автомобиля и отклик', fill="Отклик")  

```

*** Вывод***: Из тех, кто откликнулся на предложение, больше людей без автомобиля. Возможно, это стоит учитывать банку, поскольку этим клиентам может быть необходим кредит на покупку автомобиля. Однако и те, кто имеет автомобиль, заинтересованы в предложении, но их меньше.

```{r Регион и отклик}
ggplot(otp, aes(x = region_nm, fill = targetf)) +
  geom_bar(position = 'fill') +
  scale_y_continuous(labels = percent) +
  labs(fill = 'Отклик')  + coord_flip()

```

*** Вывод***: По результату видно, что банку стоит обратить чуть больше внимания Восточно-Сибирскому и Уральскому регионам. Меньший фокус стоит оказывать на Приволжский, Поволжский регионы. Однако стоит помнить, что разрыв в заинтересованности услуг банка небольшой.

```{r Отклик, наличие кредита, наличие просрочек и семейное положение}

# Наличие кредита у клиента
otp <- otp %>%
  mutate(loan_num = 
           ifelse(loan_num_total-loan_num_closed > 0,  
                  'Кредит есть', 'Кредита нет'))
ggplot(otp,
  mapping = aes (x = loan_num, fill = targetf, y = ..count..)) +
  geom_bar(position = "fill") +
  facet_wrap(~marital_status, ncol = 2) +
  labs(
    title = "Отклик, наличие кредита и семейное положение",
    x = "наличие кредита",
    fill ="Отклик")+
  scale_y_continuous(labels = percent) 

# Наличие просрочек, допущенных клиентом 
otp <- otp %>%
  mutate(loan_dlq = 
           ifelse(loan_dlq_num > 0,  
                  'Есть просрочки', 'Нет просрочек'))
ggplot(otp,
  mapping = aes (x = loan_dlq, fill = targetf, y = ..count..)) +
  geom_bar(position = "fill") +
  facet_wrap(~marital_status, ncol = 2) +
  scale_y_continuous(labels = percent) +
  labs(
    title = "Отклик, наличие просрочек и семейное положение",
    x = "Наличие просрочек",
    fill ="Отклик")
```

*** Вывод***: Вне зависимости от семейного положения, больше на предложение банка откликаются те категории, у которых есть кредит. Аналогичная ситуация с наличием просрочек. Банку стоит помнить, что эти факторы предполагает определенные риски, поэтому необходимо адекватно оценивать финансовые возможности.

```{r Отклик, социальный статус и стаж}

# Стаж работы в годах
otp <- otp %>%
  mutate(work_time = work_time/12)

ggplot(otp) + 
  stat_summary(aes(x = fct_reorder(socstatus_work_fl, 
                                   work_time, 
                                   fun = mean, na.rm = T),
                   y = work_time),
               fun.y = mean, na.rm = T,
               geom = 'bar') +
  facet_wrap(~targetf, ncol = 2) +
  labs(x = NULL, 
       title = 'Отклик, социальный статус и стаж', x = "Стаж работы") +
  coord_flip()

```
**Вывод**: Банку стоит сфокусироваться на работающих людей со стажем работы до 5 лет. Однако с осторожностью относиться к тем, у кого почти нет стажа работы, а также к неработающим. Их финансовые возможости необходимо дополнительно проверять.

```{r Пол и отклик}
ggplot(otp, aes(x = genderf, fill = targetf)) +
  geom_bar(position = 'fill') +
  scale_y_continuous(labels = percent) +
  labs(fill = 'Отклик')

```
**Вывод**: Мужчины и женщины заинтересованы в предложениях банка в равной степени. 

