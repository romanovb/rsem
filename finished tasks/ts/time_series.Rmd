---
title: "Контрольная работа по прогнозированию временных рядов, вариант 33"
author: "Б. Романов"
output: 
  html_document: 
    number_sections: no
    toc: yes
    toc_depth: 3
---

```{r Настройка, include=TRUE}
knitr::opts_chunk$set(dev = 'png', warning = FALSE) 
# выбор формата для графиков и отключение жалоб на русские шрифты на графиках
options(digits = 4) # Количество значащих цифр при выводе
```

```{r Подключение библиотек, message=FALSE, warning=FALSE}
library(tidyverse) # трансформация и визуализация данных
library(forecast) # анализ временных рядов и прогнозирование
library(scales) # Форматирование осей на графиках ggplot2
library(stringr)  # Работа с текстовыми строками
library(lubridate) # Обработка дат
library(readxl) # Чтение из Excel
```

# Загрузка данных

```{r Загрузка данных варианта}
df <- read_excel('time_series.xlsx', sheet = '33')
d <- ts(df[,2], frequency = 12, start = c(1960,1))

```

# Предварительный анализ данных
## Визуализация. Временной ряд?
```{r}
autoplot(d) + 
  labs (title = "Смертность в результате ДТП в Онтарио 1960-1974", y = "Значение", x = "Дата")
```

Данные безусловно являются временным рядом, поскольку наблюдения отмечены на равных промежутках времени (помесячно).

## Закономерные компоненты

Из исходной визуализации видно, что у показателя есть повторяющиеся колебания, причем усиливающиеся с течением времени. Поэтому для выделения закономерных компонент воспользуемся мультипликативной моделью.

```{r}
decomp <- decompose(d, type = "additive")

autoplot(decomp) + 
  labs (title = "Декомпозиция вр. ряда (аддитивная модель)")
```

Наложим тренд на исходную визуализацию.
```{r}
autoplot(d, series = "Data") +
  autolayer(decomp$trend, series = "Trend") +
  labs(title = "Тренд временного ряда", color = "Ряды", y = "Значение", x = "Время")
```

Замечаем, что тренд имеет циклическую структуру, причем колебания тренда, как и колебания основного временного ряда, усиливаются со временем. Исходя из этого делаем предположение, что тренд имеет мультипликативную циклическую структуру, хоть и весьма слабо выраженную.

Общий рост ДТП в первую очередь связан с развитием автомобильного рынка и культуры использования личного автомобиля. Спады могут быть вызваны экономической обстановкой - снижение реальных доходов населения, снижение покупательской способности однозначно отражается на использовании автомобиля - от покупки до заправки и обслуживания.

### Сезонность

Ряд сезонный, аддитивного типа (колебания практически не изменяются вплоть до 1971 года, далее колебания резко увеличиваются, однако сохраняют свою амплитуду далее). Длина сезонного цикла составляет один год.

### Нетипичные наблюдения, пропуски, выбросы

Пропуски, а также выбросы, которые невозможно было бы объяснить случайной компонентой отсутствуют.
Как уже было отмечено ранее, после 1971 ряд меняет свое поведение, однако все-таки продолжает сохранять общую тенденцию.

Корректировать временной ряд не требуется.

Для построения модели можно использовать весь временной ряд, поскольку резкий рост в упомянутом периоде отражен в тренде.

# Построение и выбор модели

Данный временной ряд лучше всего могут описать модели, учитывающие сезонность.
  
Построим модели разных типов на исторических данных.

```{r}
dd <- window(d, start = 1971.1)
dt <- window(d, end = 1974.1)
da <- hw(dt, seasonal = "additive", h = 24)
autoplot(dd, series = "fact") +
  autolayer(da, series = "fcst", PI = F) +
  labs (title = "Аддитивная модель Хольта-Винтерса", y = "Кол-во", x = "Год", color = "Ряд") 
```

Видим, что аддитивная модель в целом соблюдает движение временного ряда, однако не учитывает увеличившиеся колебания.

```{r}
dd1 <- window(d, start = 1971.1)
dt1 <- window(d, end = 1974.1)
da1 <- hw(dt1, seasonal = "multiplicative", h = 24)
autoplot(dd1, series = "fact") +
  autolayer(da1, series = "fcst", PI = F) +
  labs (title = "Мультипликативная модель Хольта-Винтерса", y = "Кол-во", x = "Год", color = "Ряд") 
```


Мультипликативная модель гораздо ближе к фактическим данным, однако все еще не учитывает возросшие колебания. Попробуем отказаться от гипотезы о том, что допустимо использовать весь временной ряд и перестроим модели основываясь на данных с 1971 года.

```{r}
dd <- window(d, start = 1971.1)
dt <- window(d, start = 1971.1, end = 1974.1)
da <- hw(dt, seasonal = "additive", h = 24)
autoplot(dd, series = "fact") +
  autolayer(da, series = "fcst", PI = F) +
  labs (title = "Аддитивная модель Хольта-Винтерса", y = "Кол-во", x = "Год", color = "Ряд") 
```

```{r}
dd1 <- window(d, start = 1971.1)
dt1 <- window(d, start = 1971.1, end = 1974.1)
da1 <- hw(dt1, seasonal = "multiplicative", h = 24)
autoplot(dd1, series = "fact") +
  autolayer(da1, series = "fcst", PI = F) +
  labs (title = "Мультипликативная модель Хольта-Винтерса", y = "Кол-во", x = "Год", color = "Ряд") 
```

Перестраивание на меньшем наборе исторических данных не подсказало модели увеличение колебаний. Вероятно, пики связаны со случайной компонентой временного ряда. Тем не менее, лучше себя показала мультипликативная модель, построенная на всем периоде данных. Проведем полноценный ex-post анализ для аддитивной и мультипликативной моделей.

```{r}
exdl <- window(d, end = 1973.1)
exhwm <- hw(exdl, seasonal = "multiplicative", h = 24)

autoplot(dd1, series = "Факт") +
  autolayer(exhwm, series = "Прогноз", PI = F)+
  labs (title = "Мультипликативная модель Хольта-Винтерса", y = "Кол-во", x = "Год", color = "Ряд") 

autoplot(d, series = "Факт") +
  autolayer(exhwm, series = "Прогноз", PI = F) +
  labs (title = "Мультипликативная модель Хольта-Винтерса", y = "Кол-во", x = "Год", color = "Ряд") 

exhwa <- hw(exdl, seasonal = "additive", h = 24)
autoplot(dd1, series = "Факт") +
  autolayer(exhwa, series = "Прогноз", PI = F) +
  labs (title = "Аддитивная модель Хольта-Винтерса", y = "Кол-во", x = "Год", color = "Ряд") 

autoplot(d, series = "Факт") +
  autolayer(exhwa, series = "Прогноз", PI = F) +
  labs (title = "Аддитивная модель Хольта-Винтерса", y = "Кол-во", x = "Год", color = "Ряд") 

```


Сравнив две модели визуально, видим, что мультипликативная лучше подстроена под характер временного ряда. Проверим это утверждение с помощью исследования ошибок прогноза.

```{r}
rbind(accuracy(exhwa, d)[2,], 
      accuracy(exhwm, d)[2,])%>%
  
  as_tibble() %>%
  round(2) %>%
  mutate(`Модель` = c('Аддитивная', "Мультипликативная")) %>%
  select(`Модель`, MASE, MAPE, everything()) %>%
  arrange(MASE)

```

Действительно, несмотря на то, что по некоторым ошибкам (например ME и MPE), мультипликативная модель уступает, в остальных случая эта модель более аккуратна, хотя и не имеет большого отрыва. 

Проведем еще одно сравнение аккуратности с помощью метода скользящего контроля.

```{r}
RMSE <- function(errors) {
  errors^2 %>% mean(na.rm = T) %>% sqrt()
}

```


```{r}
dd_err <- tibble(horizon_mult = 1:24) %>%
   mutate(error_mult = map_dbl(horizon_mult, 
                         function(x) tsCV(dd, hw, seasonal = "multiplicative", h = x) %>% RMSE()))

head(dd_err)

d_err <- tibble(horizon_add = 1:24) %>%
   mutate(error_add = map_dbl(horizon_add, 
                         function(x) tsCV(dd, hw, seasonal = "additive", h = x) %>% RMSE()))
head(d_err)

cbind(dd_err, d_err)  %>%
  
  as_tibble() %>%
  round(2) %>% head()
```

Замечаем, что аддитивная модель на скользящем горизонте с некоторой периодичностью показывает меньшую ошибку RMSE, чем мультипликативная модель. Тем не менее, если просмотреть таблицу до конца - эти случаи остаются единичными.

Для разработки прогноза будем использовать мультипликативную модель. Она является достаточно аккуратной и в целом сохраняет характер временного ряда.

# Разработка прогноза

Строим модель:
```{r}
fcst <- hw(d, sesonal = "multiplicative", h = 26)

autoplot(d, series = "Факт") +
  autolayer(fcst, PI = F, series = "Прогноз") +
  labs (title = "Итоговый прогноз", x = "Дата", y = "Кол-во", color = "Ряд")
```

В основу прогноза заложены следующие предположения:

1. Поведение тренда сохранится на горизонте прогнозирования
2. Резкие колебания в 1971-1974 гг. вызваны случайными причинами и не являются новым характером поведения временного ряда.

Для разработки прогноза использованы сезонность и тренд. На мой взгляд, сезонность сохранится полностью, а тренд сохранится еще некоторое время, а затем резкой пойдет вверх в связи с резким увеличением количества личного транспорта на стыке веков.

Данный прогноз в корректировке не нуждается, прогнозу доверяю.





