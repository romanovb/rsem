---
title: "Методы экспоненциального сглаживания"
author: "Б. Романов, М. Вотякова, Д.Пак"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Введение

В этом задании необходимо построить несколько моделей прогнозирования для различных макроэкономических показателей из ЕАЭСД (sophist). 

Выполните пункты задания, перечисленные ниже и ответьте на поставленные в задании вопросы.

Решения присылайте в HTML-формате на `postlogist@gmail.com`.

Задание можно делать в небольших группах (2-3 человека). Не забудьте указать авторов в заголовке документа.

------

# Задания

```{r, message=FALSE, warning=FALSE}
library(tidyverse) # визуализация и трансформация данных
library(forecast) # анализ временных рядов и прогнозирование
library(fpp) # Примеры временных рядов
library(sophisthse) # Загрузка временных рядов из базы Sophist
```


## 1. Прогноз численности населения России методом экспоненциального сглаживания

1. Загрузите из EАЭСД (sophist) ряд с годовыми показателями численности населения России (`POPNUM_Y`).  
2. Используя метод простого экспоненциального сглаживания, постройте прогноз численности населения на 5 лет (константу сглаживания не задавайте, она будет подобрана автоматически).  
3. Выведите и проанализируйте сводку по модели (`summary()`):  
   - Чему равна константа сглаживания?  
   - Интерпретируйте показатели ошибки.  
4. Визуализируйте прогноз и значения уровня ряда в историческом периоде.  
5. Попробуйте задать несколько различных значений константы сглаживания. Как это влияет на уровень ряда и прогноз?  
6. Можно ли доверять прогнозу? Почему?  


## 2. Прогноз численности населения России методом Хольта

1. Продолжите работу с годовыми показателями численности населения России (`POPNUM_Y`). Используя метод Хольта, постройте прогноз численности населения на 5 лет (константы сглаживания не задавайте, они будут подобраны автоаматически).  
2. Выведите и проанализируйте сводку по модели (`summary()`):  
   - Чему равны константы сглаживания?  
   - Интерпретируйте показатели ошибки и сравните их с ошибками метода простого экспоненциального сглаживания.  
3. Визуализируйте прогноз и значения уровня ряда в историческом периоде.  
4. Попробуйте задать несколько различных значений констант сглаживания. Как это влияет на компоненты ряда и прогноз?  
5. Можно ли доверять прогнозу? Почему?  



## 3. Прогнозирование индекса пассажирооборота транспорта общего пользования

1. Загрузите из EАЭСД (sophist) ряд с месячными показателями индекса пассажирооборота транспорта общего пользования (`TRP_M_PASS_DIRI`).  
2. Визуализируйте ряд и изучите структуру его закономерных компонентов. Когда наблюдаются периоды повышенного спроса на пассажирские перевозки? Чем это обусловлено? Какой это тип сезонности?  
3. Как кризисы повлияли на тренд пассажироооборота? Что при этом произошло с сезонным компонентом?
4. На основе ваших выводов о структуре ряда, выберите подходящую модель прогнозирования.  
5. Надо ли ограничивать глубину исторического периода при построении модели, или следует взять все данные?  
6. Методом Ex-Post прогнозирования сравните 2-3 варианта модели, различающиеся типом сезонности и/или значениями констант. В качестве тестового периода используйте последние 12 месяцев от имеющихся данных. Сравнение необходимо провести визуальным методом и с помощью показателей ошибок.   
7. Выберите лучшую модель и постройте модель с такими же параметрами, использующую актуальные данные о пассажирообороте (т.е. теперь тестовый период исключать не нужно). С помощью полученной модели сделайте прогноз пассажирооборота на 2 года вперед.  
8. При помощи метода скользящего контроля оцените стандартную ошибку прогноза на горизонте 1, 3, 6, 12 и 24 месяцев.  


```{r}
trp <- sophisthse('TRP_M_PASS_DIRI')
```

```{r, message=FALSE, warning=FALSE}
trpd <- trp %>% 
  decompose(type = "multiplicative")

autoplot(trpd)

autoplot(trp) + 
  autolayer( window(trp, start = 2008.6, end = 2009.6), color = "red") +
  autolayer(window(trp,start = 2014.1, end = 2016.12), color = "blue") +
  autolayer(trendcycle(trpd), color = "green") +
  scale_x_yearmon(n=9) 
```

### Закономерные компоненты

Наблюдаем ежегодную сезонность со спадами зимой (январь-февраль) и пиками в середине года (май-июнь). Это связано с государственными праздниками и началом сезона отпусков. Тип сезонности - аддитивный, т.к. колебания увеличиваются незначительно (возможно влияние случайной компоненты).
Тренд нестабилен, но повышается.
Заметны большие колебания случайной компоненты.

### Экономические кризисы
Последние два экономических кризиса отмечены синим и красным. Их влияние можно четко проследить по линии тренда: пассажирооборот резко снижается. После кризиса 2008 года сезонность сместилась на 1 месяц. До 2008 года пиковые значения наблюдались в мае, после кризиса - в июне. Спады также сместились на 1 месяц - с декабря на январь.

### Выбор модели

```{r}
trph <- holt(trp, h = 24)

trpw <- hw(trp, h = 24, type = "additive")

autoplot(trp) +
  autolayer(trph, PI = F) +
  autolayer(trpw, PI = F)

```

### Ограничения
Поскольку при погнозированние в данном временном ряде нам важна сезонность, выбираем метод Винтерса. 
Исторические данные не нуждаются в ограничении, поскольку сходны по своей структуре и движению тренда на всем временном ряде.

### Ex-Post


```{r}

tr <- window(trp, end = c(2016, 9))

tr_ad <- hw(tr, h = 12, type = "additive")
tr_mu <- hw(tr, h = 12, type = "multiplicative")

autoplot(window(trp, start = 2016.10), series = "Факт") +
  autolayer(tr_ad$mean, series = "Аддитивная") +
  autolayer(tr_mu$mean, series = "Мультплик.")

rbind(
  accuracy(tr_ad, trp)['Test set',],
  accuracy(tr_mu, trp)['Test set',]) %>%
  as_tibble() %>%
  round(4) %>%
  mutate(`Метод` = c('Аддитивная модель', 
                     'Мультипликативная модель')) %>%
  select(`Метод`, MASE, MAPE, MPE) %>%
  arrange(MASE)
```

